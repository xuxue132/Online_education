<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.community_education.Dao.BrowseHistoryMapper" >
  <resultMap id="BaseResultMap" type="com.example.community_education.Model.BrowseHistory" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="user_phone" property="userPhone" jdbcType="VARCHAR" />
    <result column="news_id" property="newsId" jdbcType="INTEGER" />
    <result column="browse_time" property="browseTime" jdbcType="TIMESTAMP" />
    <result column="deletes" property="deletes" jdbcType="INTEGER" />
  </resultMap>

  <sql id="Base_Column_List" >
    id, user_phone, news_id, browse_time, deletes
  </sql>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from browse_history
    where id = #{id,jdbcType=INTEGER}
  </delete>

  <insert id="insertSelective" parameterType="com.example.community_education.Model.BrowseHistory" >
    insert into browse_history
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="userPhone != null" >
        user_phone,
      </if>
      <if test="newsId != null" >
        news_id,
      </if>
      <if test="browseTime != null" >
        browse_time,
      </if>
      <if test="deletes != null" >
        deletes,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="userPhone != null" >
        #{userPhone,jdbcType=VARCHAR},
      </if>
      <if test="newsId != null" >
        #{newsId,jdbcType=INTEGER},
      </if>
      <if test="browseTime != null" >
        #{browseTime,jdbcType=TIMESTAMP},
      </if>
      <if test="deletes != null" >
        #{deletes,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from browse_history
    where id = #{id,jdbcType=INTEGER}
  </select>

  <update id="updateByPrimaryKeySelective" parameterType="com.example.community_education.Model.BrowseHistory" >
    update browse_history
    <set >
      <if test="userPhone != null" >
        user_phone = #{userPhone,jdbcType=VARCHAR},
      </if>
      <if test="newsId != null" >
        news_id = #{newsId,jdbcType=INTEGER},
      </if>
      <if test="browseTime != null" >
        browse_time = #{browseTime,jdbcType=TIMESTAMP},
      </if>
      <if test="deletes != null" >
        deletes = #{deletes,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>

  <select id="selectByUserAndNews" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from browse_history
    where user_phone = #{userPhone,jdbcType=VARCHAR} and news_id = #{newsId,jdbcType=INTEGER} and deletes = 0
  </select>

  <insert id="insertOrUpdate" parameterType="com.example.community_education.Model.BrowseHistory">
    insert into browse_history (user_phone, news_id, browse_time, deletes)
    values (#{userPhone,jdbcType=VARCHAR}, #{newsId,jdbcType=INTEGER}, #{browseTime,jdbcType=TIMESTAMP}, 0)
    on duplicate key update browse_time = #{browseTime,jdbcType=TIMESTAMP}
  </insert>

  <select id="selectRecentByUser" resultMap="BaseResultMap">
    <![CDATA[
    select 
    ]]>
    <include refid="Base_Column_List" />
    <![CDATA[
    from browse_history
    where user_phone = #{userPhone,jdbcType=VARCHAR} and deletes = 0 
    and browse_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
    order by browse_time desc
    ]]>
  </select>

  <delete id="deleteOldRecords">
    <![CDATA[
    delete from browse_history
    where browse_time < DATE_SUB(NOW(), INTERVAL 7 DAY)
    ]]>
  </delete>

  <select id="countByUser" resultType="java.lang.Integer">
    <![CDATA[
    select count(*)
    from browse_history
    where user_phone = #{userPhone,jdbcType=VARCHAR} and deletes = 0
    and browse_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
    ]]>
  </select>

  <select id="selectUserBrowseHistory" resultType="map" parameterType="map">
    <![CDATA[
    select 
      bh.id,
      bh.user_phone as userPhone,
      bh.news_id as newsId,
      bh.browse_time as browseTime,
      nn.title as newsTitle,
      nn.sources as newsSources
    from browse_history bh
    inner join new_notice nn on bh.news_id = nn.id
    where bh.user_phone = #{userPhone,jdbcType=VARCHAR} 
    and bh.deletes = 0 
    and bh.browse_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
    and nn.deletes = 0
    order by bh.browse_time desc
    limit #{NowPage,jdbcType=INTEGER},10
    ]]>
  </select>

</mapper>